# One yaml file for the four RAI containers, run as a single service:
spec:
  container:
  # Support for the RAI Engine:
  - name: consul
     image: /demo_database/tpcds/rai_repository/hashicorp/consul:amd-1.16
     args: ["agent", "-server", "-bootstrap", "-ui", "-client=0.0.0.0", "-data-dir", "/consul-data/consul/data"]
     volumeMounts:
     - name: consul-mount
       mountPath: /consul-data/   
  - name: token-svc
      image: /demo_database/tpcds/rai_repository/snowflake-helper:release
      command: ["/token-updater"]
      volumeMounts:
        - name: token-stage
          mountPath: /sts-token
      env:
        STAGENAME: "rai_yaml_stage"
# The RAI Engine Server:
  - name: rai-server
    image:/demo_database/tpcds/rai_repository/rai-server:release
    args: ["rai-server", "server" ,"--config-file", "/mount/shared-stage/engineconfig.yaml"]
    env:
      SERVER_PORT: 8010
      JULIA_NUM_THREADS: 5
      CONSUL_ADDRESS: http://rai-service.tpcds.demo-database.snowflakecomputing.internal:8500
    volumeMounts:
      - name: shared-stage
        mountPath: /mount/shared-stage
      - name: token-stage
        mountPath: /mount/token-stage/token
# --------
# The Proxy Server:
# The proxy must know the name of the RAI engine/server service
# The Snowflake account info, including the warehouse, is needed for SF->RAI data copy to work
  - name: rai-proxy
    image: /demo_database/tpcds/rai_repository/rai-proxy:release
    env:
       ENGINE: localhost:8010
       SNOWFLAKE_ACCOUNT: XXXXXXX
       SNOWFLAKE_DATABASE: DEMO_DATABASE
       SNOWFLAKE_SCHEMA: TPCDS
       SNOWFLAKE_ROLE: DEMO_ROLE
       SNOWFLAKE_WAREHOUSE: DEMO_WAREHOUSE
# -------
  endpoint:
    - name: proxyendpoint
      port: 8080
      public: false
    - name: serverendpoint
      port: 8010
      public: false
    - name: consul
      port: 8500
      public: true
  volumes:
    - name: token-stage
      source: '@rai_yaml_stage/token'
      uid: 1000
      gid: 1000
    - name: shared-stage
      source: '@rai_yaml_stage/config'
      uid: 1000
      gid: 1000
    - name: consul-mount
      source: '@rai_yaml_stage/consul'
      uid: 100
      gid: 1000
    
